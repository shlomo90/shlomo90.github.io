---
layout: post
tags: nginx programming
title: Nginx Initialization module (http)
comments: true
---


# HTTP Module Initialization

.

## http block


* `ngx_init_cycle` 함수에서 아래 파싱 함수를 수행
    * `ngx_conf_param`
        * `-g` 옵션으로 들어온 파라미터를 파싱하는 함수
        * 내부적으로 `ngx_conf_parse` 함수를 호출하지만, 파일이름은 없음
    * `ngx_conf_parse`
        * nginx.conf 와 같은 파일을 읽어서 파싱하는 함수

* HTTP 블럭 파싱 시, `http {` 을 만나면, `http` 에 대한 이름에 대해 모듈의 command 의 순회하여 찾는다.
    * `http` 를 찾기 위해선 현재 모듈이 NGX_CORE_MODULE 이고, command 의 타입이 NGX_MAIN_CONF 이어야 한다. (Flag 체크 수행)
        * NGX_MAIN_CONF 의 뜻은 최 상단에서 conf 임을 나타내는듯.(확인 필요)
        * 참고로, 파싱시 사용되는 `cf` 변수는 현재 문맥에 맞는 플래그를 가지고 있음.
        * 예를 들어, 최상위 블럭인 core 에서 수행중일 때와 http 블럭 내 에서 수행 중일때 값이 변하면서 recursive 하게 수행
* HTTP 에 대한 command 를 찾으면 해당 모듈의 `conf` 메모리 주소를 구하여 `cmd->set` 함수 파라미터로 넘겨서 수행한다.
    * `conf` 값은 파싱 전에 CORE MODULE 에 대해서 미리 `create_conf` 작업을 수행합니다.
    * 단, `http` 와 같이 block 시작 directive 는 **NULL 값을 가지는 변수의 주소를** 넘겨줍니다.
    * 왜냐면, `http` 는 내부적으로 `ctx` (`main_conf, srv_conf, loc_conf` 를 가짐) 를 생성하고, HTTP 모듈에 대한 파싱 진행


* main_conf, srv_conf, loc_conf 메모리 구조

```
+----+----+----+----+----+----+----+----+
| M1 | M2 | M3 | M4 | M5 | M6 | .. | MN |
+----+----+----+----+----+----+----+----+

+-------------------------------+
|   ctx (ngx_http_conf_ctx_t)  ----+  (http block)
+-------------------------------+  |
|           ...                 |  |
+-------------------------------+<-+
|   main_conf                  ----+  <-------------+
+-------------------------------+  |                |
|   srv_conf                   ----|--+             |
+-------------------------------+  |  |             |
|   loc_conf                   ----|--|--+          |
+-------------------------------+  |  |  |          |
|           ...                 |  |  |  |          |
+-------------------------------+<-+  |  |          |
|   http module 1's main_conf   |     |  |          |
|   (e.g, ngx_http_core_module) +-----------+       |
+-------------------------------+     |  |  |       |
|   http module 2's main_conf   |     |  |  |       |
+-------------------------------+     |  |  |       |
|           ...                 |     |  |  |       |
+-------------------------------+     |  |  |       |
|   http module n's main_conf   |     |  |  |       |
+-------------------------------+     |  |  |       |
|           ...                 |     |  |  |       |
+-------------------------------+<----+  |  |       |
|   http module 1's srv_conf    |        |  |       |
|   (e.g, ngx+http_core_module)------------------------------> cscf->ctx ---+
+-------------------------------+        |  |       |              
|   http module 2's srv_conf    |        |  |       |              
+-------------------------------+        |  |       |              
|           ...                 |        |  |       |              
+-------------------------------+        |  |       |              
|   http module n's srv_conf    |        |  |       |              
+-------------------------------+        |  |       |              
|           ...                 |        |  |       |              
+-------------------------------+<-------+  |       |              
|   http module 1's loc_conf    |           |       |              
+-------------------------------+           |       |              
|   http module 2's loc_conf    |           |       |              
+-------------------------------+           |       |              
|           ...                 |           |       |              
+-------------------------------+           |       |              
|   http module n's loc_conf    |           |       |              
+-------------------------------+           |       |              
|           ...                 |           |       |              
+-------------------------------+<----------+       |              
|   server[0] (_core_srv_conf_t)------------------------->ctx----------+
+-------------------------------+                   |                  |
|   server[1] (_core_srv_conf_t)|                   |                  |
+-------------------------------+                   |                  |
|   server[2] (_core_srv_conf_t)|                   |                  |
+-------------------------------+                   |                  |
|   server[3] (_core_srv_conf_t)|                   |                  |
+-------------------------------+                   |                  |
|           ...                 |                   |                  |
+-------------------------------+ (server block)    |                  |
|   ctx (ngx_http_conf_ctx_t)  -----+---+---+       | <------------+<--+
+-------------------------------+<--+   |   |       |              |    
|   main_conf                  ---------|---|-------+              |    
+-------------------------------+<------+   |       ^              |    
|   srv_conf                   -------+     |       |              |    
+-------------------------------+<----|-----+        \             |    
|   loc_conf                   -------|--+            \       cscf->ctx 
+-------------------------------+     |  |            |            |    
|           ...                 |     |  |            |            |         
+-------------------------------+<----+ <------------------+       |      
|   http module 1's srv_conf  -------------------------------------+ 
+-------------------------------+        |            |    |
|   http module 2's srv_conf    |        |            |    |
+-------------------------------+        |            |    |
|           ...                 |        |            |    |
+-------------------------------+        |            |    |
|   http module n's srv_conf    |        |            |    |
+-------------------------------+        |            |    |
|           ...                 |        |            |    |
+-------------------------------+<-------+            |    |
|   http module 1's loc_conf    |                     |    |
+-------------------------------+                     |    |
|   http module 2's loc_conf    |                     |    |
+-------------------------------+                     |    |
|           ...                 |                     |    |
+-------------------------------+                     |    |
|   http module n's loc_conf    |                     |    |
+-------------------------------+                     |    |
|           ...                 |                     |    |
+-------------------------------+                     |    |
|   ctx (ngx_http_conf_ctx_t)  -----+ (location block)|    |
+-------------------------------+<--+                 |    |
|   main_conf                  -----------------------+    |
+-------------------------------+                          |
|   srv_conf                   ----------------------------+
+-------------------------------+
|   loc_conf                   -------+
+-------------------------------+     |
|           ...                 |     |
+-------------------------------+<----+
|   http module 1's loc_conf    |
+-------------------------------+
|   http module 2's loc_conf    |
+-------------------------------+
|           ...                 |
+-------------------------------+
|   http module n's loc_conf    |
+-------------------------------+

즉, ngx_http_merge_servers 는 각각 산발된 server, location 설정 값들은
main <- server <- location 순으로 머지해나가는 것.
최종적으로는 core 의 main 에서의 설정들이 각 server 로 merge 됩니다.
참고로, 각 모듈별로만 merge 가 된다.
http <-> server : ngx_http_merge_servers 함수에서 server 의 설정이 http 의 server 로 덮어씌어짐
server <-> locaion : location 블럭에서 파싱한 location 에 대해서...

```


### Merge

* http block 파싱 시 `http_ctx` 는 `main_conf`, `srv_conf`, `loc_conf` 를 가짐.
* server block 파싱 시 ctx 가 새롭게 할당되고 이때 `main_conf`, `srv_conf`, `loc_conf` 도 다시 create_conf 작업을 수행
    * http_core_module 의 srv_conf 도 새롭게 할당되고 cscf 에 새롭게 할당한 `ctx` 추가
    * cscf 는 cmcf->server 에 리스트에 추가됨

* http_ctx 와 각 서버별 ctx 는 따로 메모리 영역에 있음으로 각 서버별 ctx 들은 부모 http_ctx 의 상속 필요.
  (단, 각 서버에 이미 설정되어있다면, 상속 받지 아니함.)
